name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Start SQL Server container
      - name: Start SQL Server container
        run: |
          docker run -e "ACCEPT_EULA=Y" \
                     -e "SA_PASSWORD=${{ secrets.SA_PASSWORD }}" \
                     -p 1433:1433 \
                     --platform linux/amd64 \
                     --name sqlserver-test \
                     -d mcr.microsoft.com/mssql/server:2022-latest

      # 5. Wait for SQL Server to be ready
      - name: Wait for SQL Server to be ready
        run: |
          for i in {1..30}; do
            /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P ${{ secrets.SA_PASSWORD }} -Q "SELECT 1" && break
            echo "Waiting for SQL Server..."
            sleep 5
          done

      # 6. Run pytest with coverage
      - name: Run tests
        run: |
          mkdir -p reports
          pytest --junitxml=reports/junit.xml --cov=. --cov-report xml:reports/coverage.xml --cov-fail-under=70

      # 7. Upload reports
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports
