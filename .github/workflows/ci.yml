name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Start SQL Server container
      - name: Start SQL Server container
        run: |
          docker run -e "ACCEPT_EULA=Y" \
                     -e "SA_PASSWORD=${{ secrets.SA_PASSWORD }}" \
                     -p 1433:1433 \
                     --platform linux/amd64 \
                     --name sqlserver-test \
                     -d mcr.microsoft.com/mssql/server:2022-latest

      # 5. Wait for SQL Server to be ready
      - name: Wait for SQL Server to be ready
        run: |
          for i in {1..30}; do
            /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P ${{ secrets.SA_PASSWORD }} -Q "SELECT 1" && break
            echo "Waiting for SQL Server..."
            sleep 5
          done

      # 6: Install driver
      - name: Install SQL Server ODBC Driver
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg2
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc > /dev/null
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18
          sudo apt-get install -y unixodbc-dev

      # 7. Run pytest with coverage
      - name: Run tests
        run: |
          mkdir -p reports
          pytest --junitxml=reports/junit.xml \
                --cov=./ \
                --cov-report xml:reports/coverage.xml \
                --cov-fail-under=70 \
                --cov-report term-missing

      # 8. Upload reports
      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports
